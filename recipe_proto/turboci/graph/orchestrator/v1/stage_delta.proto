// Copyright 2025 The Chromium Authors
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

syntax = "proto3";

package turboci.graph.orchestrator.v1;

import "turboci/graph/ids/v1/identifier.proto";
import "turboci/graph/orchestrator/v1/dependencies.proto";
import "turboci/graph/orchestrator/v1/field_options.proto";
import "turboci/graph/orchestrator/v1/stage_attempt_state.proto";
import "turboci/graph/orchestrator/v1/stage_state.proto";
import "turboci/graph/orchestrator/v1/value.proto";

option go_package = "go.chromium.org/turboci/proto/go/graph/orchestrator/v1;orchestratorpb";
option java_multiple_files = true;

// Encapsulates data changes to a Stage object.
message StageDelta {
  // If set, the new Stage state that was set as part of this edit.
  optional StageState state = 1;

  // NOTE: Edit.what is also the identifier for the created Stage, so is not
  // included here.

  // NOTE: Edit.realm is also the realm for the created Stage, so is not
  // included here.

  // Attempt represents a delta to a given StageAttempt.
  message Attempt {
    // The identifier of the StageAttempt which was edited.
    optional ids.v1.StageAttempt identifier = 1;

    // The state that the Attempt entered as part of this Edit.
    optional StageAttemptState state = 2;

    // Details written as part of this edit.
    //
    // NOTE: For now, the Value here will be devoid of content other than
    // `type_url`.
    repeated Value details = 3;

    // The index of the progress message(s) written as part of this edit.
    repeated int64 progress = 4;
  }
  // Attempt(s) which were modified as part of this edit.
  //
  // NOTE: This should have a maximum length of 2 when an old Attempt is made
  // INCOMPLETE at the same time a new Attempt is written as PENDING.
  repeated Attempt attempts = 2;

  // Cancelled is true if the edit cancelled this Stage.
  optional bool cancelled = 3;

  // The Stage continuation_group written as part of this edit.
  //
  // The fields within reflect what was changed in this edit:
  //   * `edges`, `predicate` and `resolution` are included in-whole, and mean
  //     that this edit modified those fields.
  //   * `resolution_events` reflects just new events resolved in this edit.
  optional Dependencies continuation_group = 4 [(turboci).id.allowed = IDENTIFIER_KIND_STAGE];
}
