// Copyright 2025 The Chromium Authors
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

syntax = "proto3";

package turboci.graph.orchestrator.v1;

import "google/api/field_behavior.proto";
import "google/protobuf/timestamp.proto";
import "turboci/graph/ids/v1/identifier.proto";
import "turboci/graph/orchestrator/v1/actor.proto";
import "turboci/graph/orchestrator/v1/check_delta.proto";
import "turboci/graph/orchestrator/v1/field_options.proto";
import "turboci/graph/orchestrator/v1/revision.proto";
import "turboci/graph/orchestrator/v1/stage_delta.proto";
import "turboci/graph/orchestrator/v1/value_ref.proto";

option go_package = "go.chromium.org/turboci/proto/go/graph/orchestrator/v1;orchestratorpb";
option java_multiple_files = true;

// Edit is a record which indicates who/what/why edited a Check or
// Stage.
//
// This has a `delta` of either CheckDelta or StageDelta, depending on the
// type of the edit.
//
// Edit Deltas are designed to be quite slim. Heavy bits of the delta (like
// Option Data) will be stored separately from this Edit.
message Edit {
  // The node which this Edit is associated with.
  optional ids.v1.Identifier for_node = 1 [
    (turboci).id.allowed = IDENTIFIER_KIND_CHECK,
    (turboci).id.allowed = IDENTIFIER_KIND_STAGE
  ];

  // Version of the check/stage that this edit resulted in.
  //
  // When an edit applies, this `version` will match the node's version.
  optional Revision version = 2;

  // The time at which this Edit will be automatically garbage collected.
  //
  // Defaults to 180 days from the time of the Edit.
  //
  // TBD: Add RPC to extend the TTL of an Edit and its data.
  optional google.protobuf.Timestamp expire_at = 3;

  // The security realm for this Edit (duplicated from the affected Check/Stage
  // to allow easy ACL resolution).
  //
  // The premise is that if you can read a Check or Stage, you can read the
  // edits for that Check or Stage.
  //
  // Read access to the Edit is governed by the same permission used for the
  // base node (e.g. turboci.checks.read or turboci.stages.read).
  optional string realm = 5 [(google.api.field_behavior) = IMMUTABLE];

  // The entity which generated this Edit.
  optional Actor created_by = 6;

  // This is the set of nodes which were included in the same WriteNodes
  // RPC as this Edit (one per `checks`, `stages`, and/or
  // `current_stage_write`). For simplicity, this will also always include
  // `for_node`.
  //
  // This may contain more nodes than were actually written in the case of
  // a partially applied write, e.g.
  //
  //   * One writer writes Check["foo", BUILD]
  //   * Another writer writes Check["foo", BUILD], Check["bar", BUILD].
  //
  // In this case, the edit on "bar" from the second write will include "foo"
  // in this set because the requested write is compatible with the state of
  // "foo".
  //
  // This can only happen with WriteNodes requests with `txn` unset (i.e.
  // 'oblivious writes').
  //
  // If you need to detect this, load e.g. `Check["foo"] / Edit[version]`. If
  // the edit does not exist, then it means foo was already written before this
  // Edit.
  repeated ids.v1.Identifier transactional_set = 7 [
    (turboci).id.allowed = IDENTIFIER_KIND_CHECK,
    (turboci).id.allowed = IDENTIFIER_KIND_STAGE,
    // IDENTIFIER_KIND_STAGE_ATTEMPT corresponds to `current_stage_write`.
    (turboci).id.allowed = IDENTIFIER_KIND_STAGE_ATTEMPT
  ];

  // If set, then the WriteNodes which created this edit was done as an
  // 'oblivious' write - that is, `txn` was not supplied in WriteNodseRequest.
  //
  // This is intended to be a hint when debugging that a non-transactional
  // write could be an issue.
  optional bool oblivious_write = 11;

  // Human and machine-readable reason for this Edit (provided as part of
  // WriteNodes).
  message Reason {
    // A 'low effort' reason for this edit.
    //
    // This is 'low effort' because it's preferable for the writer to provide
    // detailed machine-readable data in the `details` field below.
    optional string message = 1;

    // Machine-readable reason(s) for this edit.
    //
    // This is repeated to allow for standardized reason message types in
    // conjunction with workflow-specific details as part of the same write
    // record.
    //
    // By convention, these should be ordered from most to least specific, so
    // if a client has permission for multiple details of the same type, the
    // first in this list for a given type_url should be a superset of the
    // others.
    //
    // These are be unique by (type_url, realm)
    //
    // NOTE: When viewing Edits, the reader will only see the details for which
    // they have read permissions (that is - two different users may see
    // different versions of this otherwise entirely-immutable Edit).
    repeated ValueRef details = 2;
  }
  // The writer-provided reason for this Edit.
  optional Reason reason = 8;

  // TBD: Allow indication that this Edit is "important" to be able to garbage
  // collect it at a slower cadence?

  // The actual delta of this Edit.
  oneof delta {
    // This is a delta for a Check.
    //
    // `for_node` must be an Identifier.Check.
    CheckDelta check = 9;

    // This is a delta for a Stage.
    //
    // `for_node` must be an Identifier.Stage.
    StageDelta stage = 10;
  }
}
