// Copyright 2025 The Chromium Authors
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

syntax = "proto3";

package turboci.graph.orchestrator.v1;

import "google/api/field_behavior.proto";
import "google/protobuf/any.proto";

option go_package = "go.chromium.org/turboci/proto/go/graph/orchestrator/v1;orchestratorpb";
option java_multiple_files = true;

// Value wraps a google.protobuf.Any but also provides a space for the server to
// give back an alternate serialization of the Any.
//
// The fields other than `value` are only conditionally set if the user
// requested alternate serialization.
//
// These alternate serializations use an eventually-consistent version of the
// proto, so it's possible for this to be missing fields vs. what is in the
// binary `value` field. These alternate serializations can be requested via
// QueryNodes with `alternate_serialization` set. The intent is to allow UIs to
// generically display this data, or for scripts (potentially including LLMs) to
// observe the data without having the proto descriptors handy.
//
// When writing this type to the server, only `value` is allowed to be
// populated.
//
// In the future, this may also be given:
//   * additional disambiguators in addition to value.type_url. This would allow
//   multiple Values holding the same type_url in the same field (e.g. TypeX
//   "public" and TypeX "private").
//   * Workflow-provided, Orchestrator-visible index values to allow these
//   Values to be selectable in queries, without the Orchestrator having to have
//   up-to-date descriptors for the contained type in `value`.
message Value {
  // The actual value.
  optional google.protobuf.Any value = 1;

  // If true the server knows that `value` contains unknown fields according to
  // the current proto descriptor loaded on the server.
  //
  // This can happen if the server's copy of the proto descriptor for `value` is
  // out of date vs the descriptor used by the writer for this Datum.
  optional bool has_unknown_fields = 2 [(google.api.field_behavior) = OUTPUT_ONLY];

  // A ProtoJSON-serialized version of `value`.
  optional string value_json = 3 [(google.api.field_behavior) = OUTPUT_ONLY];

  // OmitReason details why this Value's content is omitted.
  enum OmitReason {
    // Default invalid value.
    OMIT_REASON_UNKNOWN = 0;

    // This Value has a type_url which was not requested by the caller.
    //
    // In this case `value.type_url` will be present, but other metadata (like
    // orchestrator-visible index values) may be present as well.
    OMIT_REASON_UNWANTED = 1;

    // This Value has a type_url which WAS requested by the user, but the caller
    // doesn't have access to it. See the surrounding Datum to see the realm to
    // which this Value belongs.
    //
    // In this case ONLY `value.type_url` (and in the future any other
    // 'disambiguator/key') will be present.
    OMIT_REASON_NO_ACCESS = 2;
  }

  // If true, `value.value` was pruned from this message either due to
  // permissions (no read access in the realm containing this Value) or due to
  // a Query filter (not in type_info.wanted).
  //
  // `value.type_url`, however will always be present as metadata.
  optional OmitReason omitted = 4 [(google.api.field_behavior) = OUTPUT_ONLY];

  // TBD: An additional disambiguator/key in addition to value.type_url?

  // TBD: Orchestrator-visible index values.
}
