// Copyright 2025 The Chromium Authors
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

syntax = "proto3";

package turboci.graph.ids.v1;

import "google/protobuf/timestamp.proto";

option go_package = "go.chromium.org/turboci/proto/go/graph/ids/v1;idspb";
option java_multiple_files = true;

// A generic identifier that can be used to identify all TurboCI graph nodes.
//
// Within some message (e.g. Check), you may see usage of Identifier.X directly
// to indicate that the Identifier there can only be a single kind. Having the
// Identifier container, however, allows for generic structures like Edge which
// can refer to multiple kinds of nodes in different contexts.
//
// No string identifiers here may contain a colon.
message Identifier {
  // The type of this Identifier.
  //
  // This should be kept in sync with the `IdentifierKind` enum.
  oneof type {
    // A whole WorkPlan.
    WorkPlan work_plan = 1;

    // A Check within a WorkPlan.
    Check check = 2;
    // Option data for a Check.
    CheckOption check_option = 3;
    // A particular Check.Result.
    CheckResult check_result = 4;
    // Data associated with a particular result in a Check.
    CheckResultDatum check_result_datum = 5;
    // An edit to a Check.
    CheckEdit check_edit = 6;
    // Option data for an edit to a Check.
    CheckEditOption check_edit_option = 7;

    // A Stage within a WorkPlan.
    Stage stage = 8;
    // A specific attempt at a Stage.
    StageAttempt stage_attempt = 9;
    // An edit to a Stage.
    StageEdit stage_edit = 10;
  }
}

// Identifies an entire TurboCI WorkPlan.
//
// Serialized as "L<id>".
message WorkPlan {
  // Globally unique identifier for this WorkPlan.
  //
  // Has the form "<digits>" and is generated by the TurboCI service.
  optional string id = 1;
}

// Identifies a Check within a WorkPlan.
//
// Serialized as "<work_plan>:C<id>".
//
// E.g. "L<work_plan.id>:C<id>"
message Check {
  // The WorkPlan this check is scoped to.
  optional WorkPlan work_plan = 1;

  // An opaque identifier unique within this WorkPlan.
  //
  // Provided by the Stage which added this Check.
  //
  // TBD: Specify the format of this ID as regex - it should have a maximum
  // length and not be allowed to contain a colon at the very least.
  optional string id = 2;
}

// Identifies an option associated with a Check within a WorkPlan.
//
// Serializes as "<check>:O<idx>".
//
// E.g. "L<check.work_plan.id>:C<check.id>:O<idx>"
//
// A CheckOption is a single `Datum`.
//
// This is separate from `Check` because it may reside in a different realm
// than the Check itself.
message CheckOption {
  // The check that this option belongs to.
  optional Check check = 1;

  // The 1-based index of this datum within the Check.options list.
  //
  // This is 1-based to distinguish it from 0/unset (which is invalid).
  optional int32 idx = 2;
}

// Identifies a Check Result within a WorkPlan.
//
// Serialized as "<check>:R<results_idx>".
//
// E.g. "L<check.work_plan.id>:C<check.id>:R<idx>"
//
// This is separate from `Check` because it may reside in a different realm
// than the Check itself.
message CheckResult {
  // The check that this result belongs to.
  optional Check check = 1;

  // The 1-based index of this result within the Check.results list.
  //
  // This is 1-based to distinguish it from 0/unset (which is invalid).
  optional int32 idx = 2;
}

// Identifies a Datum for a Check's Result within a WorkPlan.
//
// Serialized as "<result>:D<results_data_idx>".
//
// E.g. "L<result.check.work_plan.id>:C<result.check.id>:R<result.idx>:D<idx>"
//
// This is separate from `Check` because it may reside in a different realm
// than the Check itself.
message CheckResultDatum {
  // The check resunt that this datum belongs to.
  optional CheckResult result = 1;

  // The 1-based index of this datum within the Check.Result.data list.
  //
  // This is 1-based to distinguish it from 0/unset (which is invalid).
  optional int32 idx = 2;
}

// Identifies a CheckEdit within a WorkPlan.
//
// Serialized as "<check>:E<version>".
//
// E.g.
// "L<check.work_plan.id>:C<check.id>:V<version.seconds>/<version.nanos>"
message CheckEdit {
  // The check that this edit belongs to.
  optional Check check = 1;

  // The version of the Check at the time this edit was made.
  optional google.protobuf.Timestamp version = 2;
}

// Identifies a CheckEditOption within a WorkPlan.
//
// Serialized as "<check_edit>:O<idx>".
//
// E.g.
// "L<check_edit.check.work_plan.id>:C<check_edit.check.id>:V<check_edit.version.seconds>/<check_edit.version.nanos>:D<idx>"
//
// This is separate from `CheckEdit` because it may reside in a different
// realm than the CheckEdit itself.
message CheckEditOption {
  // The check that this edit belongs to.
  optional CheckEdit check_edit = 1;

  // The 1-based index of this datum within the check.options list.
  //
  // This is 1-based to distinguish it from 0/unset (which is invalid).
  optional int32 idx = 2;
}

// Identifies a Stage within a WorkPlan.
//
// If the Stage has the WorkNode type, `is_worknode` will be true, otherwise it
// is false.
//
// Worknode Stages have additional synchronization with the WorkNodes table.
// These Stages will have a numeric `id`.
//
// non-WorkNode Stages don't have any special treatment and do not have
// a restricted format for `id` (other than the usual prohibition of the use of
// colons).
//
// Serialized as "<work_plan>:?<id>" where ? is N for WorkNode Stages, and
// S for non-WorkNode Stages.
//
// E.g. "L<work_plan.id>:S<id>" or "L<work_plan.id>:N<id>".
message Stage {
  // The WorkPlan that this Stage belongs to.
  optional WorkPlan work_plan = 1;

  // True if this Stage represents a WorkNode, false otherwise.
  optional bool is_worknode = 2;

  // An opaque identifier unique within this WorkPlan.
  //
  // For WorkNodes (`is_worknode` is true), this will a decimal integer.
  //
  // Otherwise this will be an arbitrary string supplied by the Stage which
  // added this.
  optional string id = 3;
}

// Identifies a Stage Attempt within a Stage.
//
// Note that Stage.Attempt is embedded within a Stage, but we need a reference
// to it from various places (e.g. Check and Stage Edits), so it has an
// Identifier here. Most users will use Stage instead.
//
// Serialized as "<stage>:A<attempts_idx>".
//
// E.g. "L<stage.work_plan.id>:<stage.id>:A<attempts_idx>"
message StageAttempt {
  // The Stage that this Stage Attempt belongs to.
  optional Stage stage = 1;

  // The 1-based index of this attempt within the Stage.attempts list.
  //
  // This is 1-based to distinguish it from 0/unset (which is invalid).
  optional int32 idx = 2;
}

// Identifies a Stage Edit within a WorkPlan.
//
// Serialized as "<stage>:E<version>".
//
// E.g.
// "L<stage.work_plan.id>:<stage.id>:V<version.seconds>/<version.nanos>"
message StageEdit {
  // The stage that this edit belongs to.
  optional Stage stage = 1;

  // The version of the Stage at the time this edit was made.
  optional google.protobuf.Timestamp version = 2;
}
